<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Kaleb‚Äôs Gift List</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --accent: #22c55e;
            --accent-soft: rgba(34, 197, 94, 0.12);
            --text: #e5e7eb;
            --muted: #9ca3af;
            --danger: #ef4444;
            --border: #334155;
            --radius: 14px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
                "Segoe UI", sans-serif;
        }

        body {
            background: radial-gradient(circle at top, #1e293b 0, #020617 50%);
            color: var(--text);
            min-height: 100vh;
            padding: 24px 12px 40px;
            display: flex;
            justify-content: center;
        }

        .app {
            width: 100%;
            max-width: 860px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 12px;
            flex-wrap: wrap;
        }

        header h1 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        header h1 span {
            font-size: 1.4rem;
        }

        header small {
            color: var(--muted);
            font-size: 0.85rem;
        }

        .pill {
            border-radius: 999px;
            border: 1px solid var(--border);
            padding: 6px 12px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(15, 23, 42, 0.7);
        }

        .pill strong {
            color: var(--accent);
        }

        .pill span {
            background: rgba(34, 197, 94, 0.18);
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
        }

        main {
            display: grid;
            grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.4fr);
            gap: 16px;
        }

        @media (max-width: 900px) {
            main {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .card {
            background: radial-gradient(circle at top left, #1e293b, #020617);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 16px 16px 18px;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.8);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right,
                    rgba(34, 197, 94, 0.08),
                    transparent);
            opacity: 0.7;
            pointer-events: none;
        }

        .card-content {
            position: relative;
            z-index: 1;
        }

        .card h2 {
            font-size: 1.1rem;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card h2 span {
            font-size: 1.1rem;
        }

        .card p {
            color: var(--muted);
            font-size: 0.85rem;
            margin-bottom: 10px;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 4px;
        }

        label {
            font-size: 0.8rem;
            color: var(--muted);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        input,
        textarea {
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 7px 9px;
            background: rgba(15, 23, 42, 0.9);
            color: var(--text);
            font-size: 0.9rem;
            outline: none;
        }

        input:focus,
        textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
        }

        textarea {
            resize: vertical;
            min-height: 54px;
            max-height: 120px;
        }

        .row {
            display: flex;
            gap: 8px;
        }

        .row>label {
            flex: 1;
        }

        .btn {
            border-radius: 999px;
            border: none;
            padding: 8px 14px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
            transition: transform 0.08s ease, box-shadow 0.08s ease,
                background 0.15s ease;
            background: linear-gradient(135deg,
                    var(--accent),
                    #16a34a);
            color: #022c22;
            box-shadow: 0 14px 30px rgba(22, 163, 74, 0.45);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 18px 40px rgba(22, 163, 74, 0.6);
        }

        .btn:active {
            transform: translateY(0px) scale(0.99);
            box-shadow: 0 10px 25px rgba(22, 163, 74, 0.4);
        }

        .btn.secondary {
            background: rgba(15, 23, 42, 0.9);
            color: var(--muted);
            border: 1px solid var(--border);
            box-shadow: none;
        }

        .btn.secondary:hover {
            background: rgba(15, 23, 42, 1);
        }

        .btn.small {
            padding: 5px 10px;
            font-size: 0.8rem;
            box-shadow: none;
        }

        .list {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 520px;
            overflow-y: auto;
            padding-right: 2px;
        }

        .item {
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 9px 9px;
            background: rgba(15, 23, 42, 0.9);
            display: grid;
            grid-template-columns: minmax(0, 1fr) auto;
            gap: 8px;
            align-items: center;
        }

        .item-main {
            min-width: 0;
        }

        .title-row {
            display: flex;
            align-items: baseline;
            gap: 6px;
            margin-bottom: 3px;
        }

        .title-row strong {
            font-size: 0.95rem;
        }

        .title-row a {
            color: var(--accent);
            font-size: 0.8rem;
            text-decoration: none;
            word-break: break-all;
        }

        .title-row a:hover {
            text-decoration: underline;
        }

        .desc {
            font-size: 0.82rem;
            color: var(--muted);
            margin-bottom: 3px;
            white-space: pre-wrap;
        }

        .meta {
            font-size: 0.78rem;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .badge {
            border-radius: 999px;
            padding: 2px 8px;
            font-size: 0.75rem;
            border: 1px solid rgba(148, 163, 184, 0.6);
            color: var(--muted);
        }

        .badge.bought {
            border-color: rgba(34, 197, 94, 0.7);
            background: var(--accent-soft);
            color: var(--accent);
        }

        .badge.you {
            border-color: rgba(96, 165, 250, 0.7);
            background: rgba(37, 99, 235, 0.12);
            color: #93c5fd;
        }

        .item-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: flex-end;
            justify-content: center;
        }

        .empty-state {
            font-size: 0.85rem;
            color: var(--muted);
            border-radius: 10px;
            border: 1px dashed var(--border);
            padding: 12px;
            text-align: center;
            margin-top: 4px;
        }

        .mode-banner {
            font-size: 0.8rem;
            color: var(--muted);
            margin-top: 4px;
        }

        .mode-banner code {
            background: rgba(15, 23, 42, 0.9);
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--accent);
        }

        .danger-link {
            font-size: 0.78rem;
            color: var(--danger);
            cursor: pointer;
            text-decoration: underline;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #1f2937;
            border-radius: 999px;
        }
    </style>
</head>

<body>
    <div class="app">
        <header>
            <div>
                <h1><span>üéÑ</span> Kaleb‚Äôs Christmas List</h1>
                <small>
                    A simple, shareable list of gift ideas for friends &amp; family.
                </small>
            </div>
            <div>
                <div class="pill" id="view-pill">
                    <strong>View:</strong>
                    <span id="view-label">Owner</span>
                </div>
            </div>
        </header>

        <main>
            <!-- Left: List -->
            <section class="card">
                <div class="card-content">
                    <h2><span>üì¶</span> Gift ideas</h2>
                    <p id="list-subtitle">
                        Everything I‚Äôd love for Christmas this year.
                    </p>

                    <div class="list" id="list"></div>

                    <div class="empty-state" id="empty-state" style="display: none;">
                        No items yet.
                        <span id="empty-owner">Add items using the form on the right.</span>
                        <span id="empty-friends" style="display: none;">
                            No items yet ‚Äî check back later.
                        </span>
                    </div>
                </div>
            </section>

            <!-- Right: Controls -->
            <section class="card">
                <div class="card-content" id="owner-panel">
                    <h2><span>üßë‚Äçüíª</span> Manage my list</h2>
                    <p>
                        Add gift ideas with links, prices, and notes. Share the shopping link so friends can mark
                        purchases without revealing who bought them.
                    </p>

                    <form id="item-form">
                        <label>
                            Item name
                            <input type="text" id="name" required placeholder="Wireless headphones, books, etc." />
                        </label>

                        <div class="row">
                            <label>
                                Link (optional)
                                <input type="url" id="url" placeholder="https://example.com/product" />
                            </label>
                            <label>
                                Approx. price (optional)
                                <input type="text" id="price" placeholder="$50‚Äì$100" />
                            </label>
                        </div>

                        <label>
                            Notes (optional)
                            <textarea id="notes"
                                placeholder="Size, color, version, or anything else people should know."></textarea>
                        </label>

                        <button type="submit" class="btn">
                            <span>‚ûï</span> Add item
                        </button>
                    </form>

                    <div class="mode-banner" style="margin-top: 12px;">
                        Share this URL with friends so they can shop without spoiling surprises.
                    </div>

                    <div style="margin-top: 8px;">
                        <span class="danger-link" id="reset-list">
                            Clear my list
                        </span>
                    </div>
                </div>

                <div class="card-content" id="friends-panel" style="display: none;">
                    <h2><span>üéÅ</span> Shopping view</h2>
                    <p>
                        You‚Äôre viewing the list as a <strong>shopper</strong>. Click ‚ÄúI bought this‚Äù to let other
                        shoppers know an item is taken.
                        These purchase marks are visible to other shoppers but are not shown in the owner's edit view.
                        If you need to undo a mark, please only remove it if you were the person who set it ‚Äî that
                        preserves accuracy for everyone else.
                    </p>

                    <div class="mode-banner" style="margin-top: 10px;">
                        Marking an item helps avoid duplicate gifts. If you undo a purchase mark, only remove marks you
                        created yourself so other shoppers see the correct status.
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Added Supabase client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // Supabase client initialization (replace with your values)
        const SUPABASE_URL = "https://rjygaadgelikqffistfa.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_IwOWJrfCvpwtUT9mS_2uBQ_hjyVpepU";

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- View mode detection (owner vs friends) ---
        const params = new URLSearchParams(window.location.search);
        // Default to friends/shopping view unless you explicitly add ?owner
        const isFriendsView = !params.has("owner");

        const viewLabel = document.getElementById("view-label");
        const listSubtitle = document.getElementById("list-subtitle");
        const ownerPanel = document.getElementById("owner-panel");
        const friendsPanel = document.getElementById("friends-panel");
        const emptyOwner = document.getElementById("empty-owner");
        const emptyFriends = document.getElementById("empty-friends");

        if (isFriendsView) {
            viewLabel.textContent = "Shopping (friends)";
            listSubtitle.textContent =
                "Browse the list and mark items you plan to buy ‚Äî this helps avoid duplicate gifts. Marks are visible to other shoppers but are not shown in the owner's edit view.";
            ownerPanel.style.display = "none";
            friendsPanel.style.display = "block";
            emptyOwner.style.display = "none";
            emptyFriends.style.display = "inline";
        } else {
            viewLabel.textContent = "Owner (manage)";
            listSubtitle.textContent =
                "Add and manage gift ideas. Share the shopping link so friends can mark purchases without spoiling surprises.";
            ownerPanel.style.display = "block";
            friendsPanel.style.display = "none";
            emptyOwner.style.display = "inline";
            emptyFriends.style.display = "none";
        }

        // --- Local persistence (prototype) ---
        let items = [];
        let purchases = []; // replaces friendBuys

        async function loadData() {
            // Load items
            const { data: itemsData, error: itemsError } = await supabaseClient
                .from("items")
                .select("*")
                .order("created_at", { ascending: true });

            if (itemsError) {
                console.error("Error loading items:", itemsError);
                items = [];
            } else {
                items = itemsData || [];
            }

            // Only load purchases in friends view
            if (isFriendsView) {
                const { data: purchasesData, error: purchasesError } = await supabaseClient
                    .from("purchases")
                    .select("*");

                if (purchasesError) {
                    console.error("Error loading purchases:", purchasesError);
                    purchases = [];
                } else {
                    purchases = purchasesData || [];
                }
            } else {
                purchases = [];
            }

            render();
        }

        // --- Rendering ---
        const listEl = document.getElementById("list");
        const emptyStateEl = document.getElementById("empty-state");

        function render() {
            listEl.innerHTML = "";

            if (!items.length) {
                emptyStateEl.style.display = "block";
                return;
            }
            emptyStateEl.style.display = "none";

            // Simple sort: keep insertion order for now
            items.forEach((item) => {
                const li = document.createElement("div");
                li.className = "item";

                const main = document.createElement("div");
                main.className = "item-main";

                const titleRow = document.createElement("div");
                titleRow.className = "title-row";

                const title = document.createElement("strong");
                title.textContent = item.name || "Untitled item";
                titleRow.appendChild(title);

                if (item.url) {
                    const link = document.createElement("a");
                    link.href = item.url;
                    link.target = "_blank";
                    link.rel = "noopener noreferrer";
                    link.textContent = "Link";
                    titleRow.appendChild(link);
                }

                main.appendChild(titleRow);

                if (item.notes) {
                    const desc = document.createElement("div");
                    desc.className = "desc";
                    desc.textContent = item.notes;
                    main.appendChild(desc);
                }

                const meta = document.createElement("div");
                meta.className = "meta";

                if (item.price) {
                    const price = document.createElement("span");
                    price.className = "badge";
                    price.textContent = item.price;
                    meta.appendChild(price);
                }

                const boughtForThisItem = purchases.filter(
                    (p) => p.item_id === item.id
                );
                const boughtCount = boughtForThisItem.length;

                if (isFriendsView && boughtCount > 0) {
                    const bought = document.createElement("span");
                    bought.className = "badge bought";
                    bought.textContent =
                        boughtCount === 1 ? "Already bought" : `${boughtCount} people bought`;
                    meta.appendChild(bought);
                }

                main.appendChild(meta);

                li.appendChild(main);

                const actions = document.createElement("div");
                actions.className = "item-actions";

                if (isFriendsView) {
                    const hasAnyPurchase = purchases.some((p) => p.item_id === item.id);

                    const buyBtn = document.createElement("button");
                    buyBtn.className = "btn small";
                    buyBtn.title = hasAnyPurchase
                        ? "This item is marked as bought. Undo only if you were the shopper who marked it."
                        : "Mark this item as bought (visible to other shoppers)";

                    // When not bought: confirm and mark. When already bought: offer undo (clear) with confirm.
                    buyBtn.addEventListener("click", () => {
                        if (hasAnyPurchase) {
                            if (confirm("This item is already marked as bought. Only remove the mark if you were the shopper who set it. Remove the bought mark?")) {
                                clearPurchasesForItem(item.id);
                            }
                        } else {
                            if (confirm("Mark this item as bought? This will show to other shoppers that it's taken.")) {
                                markBought(item.id);
                            }
                        }
                    });

                    if (hasAnyPurchase) {
                        // Show the already-bought state but keep the button active so shoppers can undo.
                        buyBtn.innerHTML = "Already bought";
                        buyBtn.classList.add("secondary");
                    } else {
                        buyBtn.innerHTML = "<span>‚úÖ</span> I bought this";
                    }

                    actions.appendChild(buyBtn);
                } else {
                    // Owner view: edit/remove buttons, but no "bought" info.
                    const editBtn = document.createElement("button");
                    editBtn.className = "btn small secondary";
                    editBtn.textContent = "Edit";
                    editBtn.addEventListener("click", () => {
                        startEdit(item.id);
                    });

                    const deleteBtn = document.createElement("button");
                    deleteBtn.className = "btn small secondary";
                    deleteBtn.textContent = "Remove";
                    deleteBtn.addEventListener("click", () => {
                        removeItem(item.id);
                    });

                    actions.appendChild(editBtn);
                    actions.appendChild(deleteBtn);
                }

                li.appendChild(actions);

                listEl.appendChild(li);
            });
        }

        // --- Owner actions (edit/remove/add) ---
        const form = document.getElementById("item-form");
        const nameInput = document.getElementById("name");
        const urlInput = document.getElementById("url");
        const priceInput = document.getElementById("price");
        const notesInput = document.getElementById("notes");
        const resetListBtn = document.getElementById("reset-list");

        let editingId = null;

        function startEdit(id) {
            const item = items.find((i) => i.id === id);
            if (!item) return;

            editingId = id;
            nameInput.value = item.name || "";
            urlInput.value = item.url || "";
            priceInput.value = item.price || "";
            notesInput.value = item.notes || "";

            form.querySelector("button[type='submit']").innerHTML =
                "<span>üíæ</span> Save changes";
        }

        function resetForm() {
            editingId = null;
            nameInput.value = "";
            urlInput.value = "";
            priceInput.value = "";
            notesInput.value = "";
            form.querySelector("button[type='submit']").innerHTML =
                "<span>‚ûï</span> Add item";
        }

        form?.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (isFriendsView) return; // friends can't edit

            const name = nameInput.value.trim();
            const url = urlInput.value.trim();
            const price = priceInput.value.trim();
            const notes = notesInput.value.trim();

            if (!name) return;

            if (editingId) {
                const { error } = await supabase
                    .from("items")
                    .update({ name, url, price, notes })
                    .eq("id", editingId);

                if (error) {
                    console.error("Error updating item:", error);
                    return;
                }
            } else {
                const { data, error } = await supabaseClient
                    .from("items")
                    .insert([{ name, url, price, notes }])
                    .select()
                    .single();

                if (error) {
                    console.error("Error inserting item:", error);
                    return;
                }
                // don't push to `items` here ‚Äî loadData() will fetch fresh data
            }

            resetForm();
            await loadData(); // reload from server
        });

        async function removeItem(id) {
            if (!confirm("Remove this item from your list?")) return;

            const { error } = await supabaseClient.from("items").delete().eq("id", id);
            if (error) {
                console.error("Error deleting item:", error);
                return;
            }

            await loadData();
        }

        // --- Friends actions (mark as bought) ---
        const friendsResetBtn = document.getElementById("friends-reset");

        async function markBought(itemId) {
            const { error } = await supabase
                .from("purchases")
                .insert([{ item_id: itemId }]);
            if (error) {
                console.error("Error marking as bought:", error);
                return;
            }
            await loadData();
        }

        async function clearPurchasesForItem(itemId) {
            const { error } = await supabaseClient
                .from("purchases")
                .delete()
                .eq("item_id", itemId);
            if (error) {
                console.error("Error clearing purchases:", error);
                return;
            }
            await loadData();
        }

        friendsResetBtn?.addEventListener("click", async () => {
            if (
                !confirm(
                    "This will clear ALL 'bought' marks for everyone. Continue?"
                )
            )
                return;

            const { error } = await supabase.from("purchases").delete().neq("item_id", null);
            if (error) {
                console.error("Error clearing purchases:", error);
                return;
            }
            await loadData();
        });

        // --- Init ---
        loadData();
    </script>
</body>

</html>